<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Writing Rules - Scallop Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Use Scallop for Logic Programming and Neuro-symbolic Programming">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting Started</li><li class="chapter-item expanded "><a href="../installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../crash_course.html"><strong aria-hidden="true">2.</strong> Crash Course</a></li><li class="chapter-item expanded affix "><li class="part-title">Language Reference Guide</li><li class="chapter-item expanded "><a href="../language/index.html"><strong aria-hidden="true">3.</strong> Scallop and Logic Programming</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../language/relation.html"><strong aria-hidden="true">3.1.</strong> Relations and Facts</a></li><li class="chapter-item expanded "><a href="../language/rules.html" class="active"><strong aria-hidden="true">3.2.</strong> Writing Rules</a></li><li class="chapter-item expanded "><a href="../language/value_type.html"><strong aria-hidden="true">3.3.</strong> Values and Types</a></li><li class="chapter-item expanded "><a href="../language/query.html"><strong aria-hidden="true">3.4.</strong> Writing a Query</a></li><li class="chapter-item expanded "><a href="../language/recursion.html"><strong aria-hidden="true">3.5.</strong> Recursive Rules</a></li><li class="chapter-item expanded "><a href="../language/negation.html"><strong aria-hidden="true">3.6.</strong> Negations</a></li><li class="chapter-item expanded "><a href="../language/aggregation.html"><strong aria-hidden="true">3.7.</strong> Aggregations</a></li><li class="chapter-item expanded "><a href="../language/constants.html"><strong aria-hidden="true">3.8.</strong> Declaring Constants</a></li><li class="chapter-item expanded "><a href="../language/adt_and_entity.html"><strong aria-hidden="true">3.9.</strong> Algebraic Data Type and Entities</a></li><li class="chapter-item expanded "><a href="../language/magic_set.html"><strong aria-hidden="true">3.10.</strong> On-Demand Predicates</a></li><li class="chapter-item expanded "><a href="../language/loading_csv.html"><strong aria-hidden="true">3.11.</strong> Loading from CSV</a></li><li class="chapter-item expanded "><a href="../language/foreign_functions.html"><strong aria-hidden="true">3.12.</strong> Foreign Functions</a></li><li class="chapter-item expanded "><a href="../language/foreign_predicates.html"><strong aria-hidden="true">3.13.</strong> Foreign Predicates</a></li><li class="chapter-item expanded "><a href="../language/reference_guide.html"><strong aria-hidden="true">3.14.</strong> Reference Guide</a></li></ol></li><li class="chapter-item expanded "><a href="../probabilistic/index.html"><strong aria-hidden="true">4.</strong> Provenance and Probabilistic Programming</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../probabilistic/provenance.html"><strong aria-hidden="true">4.1.</strong> Provenance</a></li><li class="chapter-item expanded "><a href="../probabilistic/proofs.html"><strong aria-hidden="true">4.2.</strong> Proofs Provenance</a></li><li class="chapter-item expanded "><a href="../probabilistic/facts.html"><strong aria-hidden="true">4.3.</strong> Fact with Probability</a></li><li class="chapter-item expanded "><a href="../probabilistic/logic.html"><strong aria-hidden="true">4.4.</strong> Logic and Probability</a></li><li class="chapter-item expanded "><a href="../probabilistic/library.html"><strong aria-hidden="true">4.5.</strong> Provenance Library</a></li><li class="chapter-item expanded "><a href="../probabilistic/reasoning.html"><strong aria-hidden="true">4.6.</strong> Aggregation and Probability</a></li><li class="chapter-item expanded "><a href="../probabilistic/sampling.html"><strong aria-hidden="true">4.7.</strong> Sampling with Probability</a></li></ol></li><li class="chapter-item expanded "><a href="../scallopy/index.html"><strong aria-hidden="true">5.</strong> scallopy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../scallopy/getting_started.html"><strong aria-hidden="true">5.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../scallopy/context.html"><strong aria-hidden="true">5.2.</strong> Scallop Context</a></li><li class="chapter-item expanded "><a href="../scallopy/branching.html"><strong aria-hidden="true">5.3.</strong> Branching Executions</a></li><li class="chapter-item expanded "><a href="../scallopy/provenance.html"><strong aria-hidden="true">5.4.</strong> Configuring Provenance</a></li><li class="chapter-item expanded "><a href="../scallopy/module.html"><strong aria-hidden="true">5.5.</strong> Creating Module</a></li><li class="chapter-item expanded "><a href="../scallopy/module_input.html"><strong aria-hidden="true">5.6.</strong> Configuring Input Relations</a></li><li class="chapter-item expanded "><a href="../scallopy/module_output.html"><strong aria-hidden="true">5.7.</strong> Configuring Output Relations</a></li><li class="chapter-item expanded "><a href="../scallopy/foreign_function.html"><strong aria-hidden="true">5.8.</strong> Foreign Functions</a></li><li class="chapter-item expanded "><a href="../scallopy/foreign_predicate.html"><strong aria-hidden="true">5.9.</strong> Foreign Predicate</a></li><li class="chapter-item expanded "><a href="../scallopy/save_and_load.html"><strong aria-hidden="true">5.10.</strong> Saving and Loading</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Toolchain</li><li class="chapter-item expanded "><a href="../toolchain/cli.html"><strong aria-hidden="true">6.</strong> Scallop CLI</a></li><li class="chapter-item expanded "><a href="../toolchain/scli.html"><strong aria-hidden="true">7.</strong> Scallop Interpreter</a></li><li class="chapter-item expanded "><a href="../toolchain/sclrepl.html"><strong aria-hidden="true">8.</strong> Scallop REPL</a></li><li class="chapter-item expanded "><a href="../toolchain/sclc.html"><strong aria-hidden="true">9.</strong> Scallop Compiler</a></li><li class="chapter-item expanded affix "><li class="part-title">For Developers</li><li class="chapter-item expanded "><a href="../developer/index.html"><strong aria-hidden="true">10.</strong> For Developers</a></li><li class="chapter-item expanded "><a href="../developer/language_construct.html"><strong aria-hidden="true">11.</strong> New Language Construct</a></li><li class="chapter-item expanded "><a href="../developer/binding.html"><strong aria-hidden="true">12.</strong> New Binding</a></li><li class="chapter-item expanded affix "><li class="part-title">Resources</li><li class="chapter-item expanded "><a href="../grammar.html"><strong aria-hidden="true">13.</strong> Full Scallop Grammar</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../misc/contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Scallop Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rules"><a class="header" href="#rules">Rules</a></h1>
<p><em>Rules</em> are the fundamental to computation in Scallop.
Each rule defines the value and data flowing from some relation to another relation.
In the following program, we have defined a few facts for the <code>edge</code> relation.
On the second line, we have defined that, for each edge <code>(a, b)</code>, there is also a path <code>(a, b)</code>.
We note that here, <code>a</code> and <code>b</code> are variables instead of constants as we have with defining facts.
During computation, the two facts in <code>edge</code> will populate the <code>path</code> relation.
This way, we have defined a rule for the <code>path</code>, which is executed during computation.</p>
<pre><code class="language-scl">rel edge = {(0, 1), (1, 2)}
rel path(a, b) = edge(a, b) // (0, 1), (1, 2)
</code></pre>
<p>In this section, we talk about how we write rules in Scallop and how intricate computation can be done through it.</p>
<h2 id="syntax"><a class="header" href="#syntax">Syntax</a></h2>
<p>In general, the basic rules in Scallop are of the form</p>
<pre><code>RULE    ::= rel ATOM = FORMULA
FORMULA ::= ATOM
          | not ATOM
          | CONSTRAINT
          | AGGREGATION
          | FORMULA and FORMULA
          | FORMULA or FORMULA
          | ( FORMULA )
</code></pre>
<p>For each rule, we name the atom on the left to be the <em>head</em> of the rule, and the formula on the right to be the <em>body</em>.
We read it from right to left: when the body formula holds, the head also holds.
The formula might contain atoms, negated atoms, aggregations, conjunction, disjunction, and a few more constructs.
For this section, we focus on simple (positive) atom, constraints, and their conjunctions and disjunctions.
We will leave the discussion of negation and aggregation to the next sections.</p>
<h2 id="atom"><a class="header" href="#atom">Atom</a></h2>
<p>Simple atoms are of the form <code>RELATION(ARG_1, ARG_2, ...)</code>.
Similar to facts, we have the relation name followed by a tuple of numerous arguments.
Now, the arguments can be of richer forms, involving variables, constants, expressions, function calls, and many more.</p>
<p>Considering the most basic example from above:</p>
<pre><code class="language-scl">rel path(a, b) = edge(a, b)
</code></pre>
<p>We have two variables <code>a</code> and <code>b</code> <em>grounded</em> by the <code>edge</code> relation.
This means we are treating the variables <code>a</code> and <code>b</code> as source of information, which can be propagated to the head.
In this example, the head also contains two variables, both being grounded by the body.
Therefore the whole rule is well formed.</p>
<p>In case the head variables are not grounded by the body, such as the following,</p>
<pre><code class="language-scl">rel path(a, c) = edge(a, b)
</code></pre>
<p>we would get an error that looks like the following:</p>
<pre><code>[Error] Argument of the head of a rule is ungrounded
  REPL:1 | rel path(a, c) = edge(a, b)
         |             ^
</code></pre>
<p>The error message points us to the variable <code>c</code> that has not being grounded in the body.</p>
<p>For basic atoms, such as the ones that the user has defined, can be used to directly ground variables which are directly arguments of the atoms.
They can be used to ground other variables or expressions.
In the following example, although the rule itself might not make any sense, the variable <code>a</code> is used to ground the expression <code>a + 1</code>.
Therefore, the rule is completely valid.</p>
<pre><code class="language-scl">rel output_relation(a, a + 1) = input_relation(a)
</code></pre>
<p>In certain cases, expressions can be used to bound variables as well!</p>
<pre><code class="language-scl">rel output_relation(a, b) = input_relation(a, b + 1)
</code></pre>
<p>In the above example, the expression <code>b + 1</code> can be used to derive <code>b</code>, and thus making the variable <code>b</code> grounded.
However, this might not be true for other expressions:</p>
<pre><code class="language-scl">rel output_relation(b, c) = input_relation(b + c) // FAILURE
</code></pre>
<p>The <code>input_relation</code> can ground the expression <code>b + c</code> directly, however, the two arguments <code>b</code> and <code>c</code> cannot be derived from their sum, as there are (theoretically) infinite amount of combinations.
In this case, we will get a compilation failure.</p>
<p>There can be constraints present in atoms as well.
For example, consider the following rule:</p>
<pre><code class="language-scl">rel self_edge(a) = edge(a, a)
</code></pre>
<p>The atom <code>edge(a, a)</code> in the body grounds only one variable <code>a</code>.
But the pattern is used to match any edge that goes from <code>a</code> and to <code>a</code> itself.
Therefore, instead of grounding two values representing the &quot;from&quot; and &quot;to&quot; of an <code>edge</code>, we are additionally posing constraint on the type of edge that we are matching.
Conceptually, we can view the above rule as the following equivalent rule:</p>
<pre><code class="language-scl">rel self_edge(a) = edge(a, b) and a == b
</code></pre>
<p>where there is an additional constraint posed on the equality of <code>a</code> and <code>b</code>.
We are going to touch on <code>and</code> and constraints in the upcoming sections.</p>
<h2 id="disjunction-or"><a class="header" href="#disjunction-or">Disjunction (Or)</a></h2>
<p>The body formula can contain logical connectives such as <code>and</code>, <code>or</code>, <code>not</code>, and <code>implies</code>, used to connect basic formulas such as <em>Atom</em>.
In the following example, we are defining that if <code>a</code> is <code>b</code>'s <em>father</em> or <em>mother</em>, then <code>a</code> is <code>b</code>'s parent:</p>
<pre><code class="language-scl">rel parent(a, b) = father(a, b)
rel parent(a, b) = mother(a, b)
</code></pre>
<p>In this program, we have divided the derivation of <code>parent</code> into two separate rules, one processing the <code>father</code> relationship and the other processing the <code>mother</code> relationship.
This natually form a disjunction (or), as the derivation of <code>parent</code> can come from 2 disjunctive sources.
Note that in Scallop (or Datalog in general), the ordering of the two rules does not matter.</p>
<p>Therefore, given that</p>
<pre><code class="language-scl">rel father = {(&quot;Bob&quot;, &quot;Alice&quot;)}
rel mother = {(&quot;Christine&quot;, &quot;Alice&quot;)}
</code></pre>
<p>we can derive that the <code>parent</code> relation holding two tuples, <code>(&quot;Bob&quot;, &quot;Alice&quot;)</code> and <code>(&quot;Christine&quot;, &quot;Alice&quot;)</code>.</p>
<p>The above program can be rewritten into a more compact form that looks like the following:</p>
<pre><code class="language-scl">rel parent(a, b) = father(a, b) or mother(a, b)
// or
rel parent(a, b) = father(a, b) \/ mother(a, b)
</code></pre>
<p>We have used an explicit <code>or</code> (<code>\/</code>) keyword to connect the two atoms, <code>father(a, b)</code> and <code>mother(a, b)</code>.
The <code>\/</code> symbol, which is commonly seen in the formal logics as the symbol vee (\(\vee\)), is also supported.
Notice that written in this way, each branch of the disjunction need to fully bound the variables/expressions in the head.</p>
<h2 id="conjunction-and"><a class="header" href="#conjunction-and">Conjunction (And)</a></h2>
<p>To demonstrate the use of <code>and</code>, let's look at the following example computing the relation of <code>grandmother</code> based on <code>father</code> and <code>mother</code>:</p>
<pre><code class="language-scl">rel grandmother(a, c) = mother(a, b) and father(b, c)
// or
rel grandmother(a, c) = mother(a, b) /\ father(b, c)
</code></pre>
<p>Notice that the symbol <code>/\</code> is a replacement for the <code>and</code> operator, which resembles the wedge (\(\wedge\)) symbol seen in formal logics.</p>
<p>As can be seen from the rule, the body grounds three variables <code>a</code>, <code>b</code>, and <code>c</code>.
The variables <code>a</code> and <code>b</code> comes from <code>mother</code> and the variables <code>b</code> and <code>c</code> comes from <code>father</code>.
Notice that there is one variable, <code>b</code>, in common.
In this case, we are <em>joining</em> the relation of <code>mother</code> and <code>father</code> on the variable <code>b</code>.</p>
<h2 id="constraints"><a class="header" href="#constraints">Constraints</a></h2>
<p>Rule body can have boolean constraints.
For example, the conjunctive rule above can be re-written as</p>
<pre><code class="language-scl">rel grandmother(a, c) = mother(a, b) and father(bp, c) and b == bp
</code></pre>
<p>Here, we are posing an equality (<code>==</code>) constraint on <code>b</code> and <code>bp</code>.
Normally, constraints are such kind of binary expressions involving predicates such as</p>
<ul>
<li>equality and inequality (<code>==</code> and <code>!=</code>)</li>
<li>numerical comparisons (<code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, and <code>&gt;=</code>)</li>
</ul>
<h2 id="other-constructs"><a class="header" href="#other-constructs">Other constructs</a></h2>
<p>There are other constructs available for defining rules, which we continue to discuss in detail in other sections:</p>
<ul>
<li><a href="disj_conj_head.html">Disjunctive head</a></li>
<li><a href="recursion.html">Recursive Rules</a></li>
<li><a href="negation.html">Negation</a></li>
<li><a href="aggregation.html">Aggregation</a></li>
<li><a href="foreign_predicates.html">Foreign Predicates</a></li>
</ul>
<h2 id="traditional-datalog-syntax"><a class="header" href="#traditional-datalog-syntax">Traditional Datalog Syntax</a></h2>
<p>If you are familiar with traditional Datalog, you can have it by swapping the <code>=</code> with <code>:-</code>, and the <code>and</code> to <code>,</code>
For example, the rule for defining <code>grandmother</code> can be rewritten as</p>
<pre><code class="language-scl">rel grandmother(a, c) :- mother(a, b), father(b, c)
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../language/relation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../language/value_type.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../language/relation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../language/value_type.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../js/hljs_scallop.js"></script>


    </div>
    </body>
</html>
